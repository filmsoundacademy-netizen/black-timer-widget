<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Notion Timer Widget</title>

<style>
  :root{
    --text:#111;
    --muted:#6b7280;
    --pill-running:#e5e7eb;      /* light grey */
    --pill-running-text:#4b5563; /* darker grey */
    --btn-main:#111;             /* black */
    --btn-main-text:#fff;        /* white */
    --btn-reset:#f3f4f6;         /* even lighter grey */
    --btn-reset-text:#4b5563;    /* same darker grey */
    --border:#e5e7eb;
    --bg:#fff;
  }

  body{
    margin:0;
    padding:12px;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background:transparent;
    color:var(--text);
  }

  .card{
    background:var(--bg);
    border-radius:16px;
    padding:14px;
    box-sizing:border-box;
    width:100%;
  }

  .top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }

  .title{
    font-weight:700;
    font-size:14px;
  }

  .pill{
    font-size:12px;
    padding:6px 10px;
    border-radius:999px;
    background:#f3f4f6;
    color:var(--muted);
    font-weight:600;
    user-select:none;
    white-space:nowrap;
  }

  .pill.running{
    background:var(--pill-running);
    color:var(--pill-running-text);
  }

  .time{
    font-size:44px;
    font-weight:800;
    letter-spacing:1px;
    text-align:center;
    margin:8px 0 12px 0;
  }

  .row{
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    margin-bottom:10px;
  }

  .stepper{
    display:flex;
    gap:6px;
    align-items:center;
    justify-content:center;
  }

  .btn{
    border:none;
    border-radius:12px;
    padding:10px 12px;
    font-weight:700;
    cursor:pointer;
    user-select:none;
  }

  .btn:active{ transform: translateY(1px); }

  .btn-small{
    padding:10px 12px;
    min-width:44px;
  }

  .btn-main{
    background:var(--btn-main);
    color:var(--btn-main-text);
  }

  .btn-reset{
    background:var(--btn-reset);
    color:var(--btn-reset-text);
  }

  .btn-ghost{
    background:#fff;
    color:var(--text);
    border:1px solid var(--border);
  }

  .presets{
    display:flex;
    gap:8px;
    justify-content:center;
    flex-wrap:wrap;
    margin-top:8px;
  }

  .preset{
    border:1px solid var(--border);
    background:#fff;
    color:var(--text);
    border-radius:999px;
    padding:8px 10px;
    font-weight:700;
    font-size:12px;
    cursor:pointer;
    user-select:none;
  }

  .preset:active{ transform: translateY(1px); }

  .hint{
    text-align:center;
    font-size:12px;
    color:var(--muted);
    margin-top:8px;
  }
</style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="title">Timer</div>
      <div id="statusPill" class="pill">Ready</div>
    </div>

    <div id="timeDisplay" class="time">25:00</div>

    <div class="row">
      <div class="stepper">
        <button class="btn btn-ghost btn-small" id="minus5" type="button">−5</button>
        <button class="btn btn-ghost btn-small" id="minus1" type="button">−1</button>
        <button class="btn btn-ghost btn-small" id="plus1"  type="button">+1</button>
        <button class="btn btn-ghost btn-small" id="plus5"  type="button">+5</button>
      </div>
    </div>

    <div class="row">
      <button class="btn btn-main" id="startPause" type="button">Start</button>
      <button class="btn btn-reset" id="reset" type="button">Reset</button>
    </div>

    <div class="presets">
      <button class="preset" data-min="60" type="button">60 min</button>
      <button class="preset" data-min="90" type="button">90 min</button>
      <button class="preset" data-min="120" type="button">120 min</button>
    </div>

    <div class="hint">Use ± to adjust minutes. Presets set the full duration.</div>
  </div>

<script>
  // ===== State =====
  let durationSeconds = 25 * 60;
  let remainingSeconds = durationSeconds;
  let running = false;

  // For accurate countdown regardless of tab throttling:
  let endTime = null;
  let rafId = null;

  const timeDisplay = document.getElementById("timeDisplay");
  const statusPill  = document.getElementById("statusPill");
  const startPause  = document.getElementById("startPause");
  const resetBtn    = document.getElementById("reset");

  // ===== Helpers =====
  function pad(n){ return String(n).padStart(2, "0"); }

  function render(){
    const m = Math.floor(remainingSeconds / 60);
    const s = remainingSeconds % 60;
    timeDisplay.textContent = `${pad(m)}:${pad(s)}`;

    if(running){
      statusPill.textContent = "Running";
      statusPill.classList.add("running");
      startPause.textContent = "Pause";
    }else{
      statusPill.textContent = (remainingSeconds === 0) ? "Done" : "Ready";
      statusPill.classList.remove("running");
      startPause.textContent = (remainingSeconds === 0) ? "Start" : "Start";
    }
  }

  function setMinutes(totalMinutes){
    durationSeconds = Math.max(0, Math.round(totalMinutes) * 60);
    remainingSeconds = durationSeconds;
    running = false;
    endTime = null;
    stopTick();
    render();
  }

  function adjustMinutes(delta){
    if(running) return; // keep simple: only adjust when paused
    const newSeconds = Math.max(0, remainingSeconds + delta * 60);
    remainingSeconds = newSeconds;
    durationSeconds = newSeconds; // treat current as new duration baseline
    render();
  }

  function stopTick(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
  }

  function tick(){
    if(!running || !endTime) return;

    const now = Date.now();
    const diffMs = endTime - now;
    remainingSeconds = Math.max(0, Math.ceil(diffMs / 1000));

    if(remainingSeconds <= 0){
      remainingSeconds = 0;
      running = false;
      endTime = null;
      stopTick();
      playAlarm();
      render();
      return;
    }

    render();
    rafId = requestAnimationFrame(tick);
  }

  function startTick(){
    // Set endTime based on current remaining
    endTime = Date.now() + remainingSeconds * 1000;
    stopTick();
    rafId = requestAnimationFrame(tick);
  }

  function toggle(){
    if(running){
      // pause
      running = false;
      // recompute remaining precisely
      if(endTime){
        const diffMs = endTime - Date.now();
        remainingSeconds = Math.max(0, Math.ceil(diffMs / 1000));
      }
      endTime = null;
      stopTick();
      render();
      return;
    }

    // start
    if(remainingSeconds <= 0){
      remainingSeconds = durationSeconds; // restart from duration if at zero
    }
    running = true;
    render();
    startTick();
  }

  function reset(){
    running = false;
    endTime = null;
    remainingSeconds = durationSeconds;
    stopTick();
    render();
  }

  // ===== Alarm sound =====
  function playAlarm(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const ctx = new AudioCtx();

      const beep = (t, freq=880, dur=0.12) => {
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = freq;
        g.gain.value = 0.0001;

        o.connect(g);
        g.connect(ctx.destination);

        o.start(t);
        g.gain.exponentialRampToValueAtTime(0.2, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);

        o.stop(t + dur + 0.02);
      };

      const t0 = ctx.currentTime + 0.02;
      beep(t0, 880, 0.14);
      beep(t0 + 0.18, 880, 0.14);

      setTimeout(() => ctx.close?.(), 800);
    }catch(e){}
  }

  // ===== Wire up UI =====
  document.getElementById("minus5").addEventListener("click", () => adjustMinutes(-5));
  document.getElementById("minus1").addEventListener("click", () => adjustMinutes(-1));
  document.getElementById("plus1").addEventListener("click",  () => adjustMinutes(1));
  document.getElementById("plus5").addEventListener("click",  () => adjustMinutes(5));

  startPause.addEventListener("click", toggle);
  resetBtn.addEventListener("click", reset);

  document.querySelectorAll(".preset").forEach(btn => {
    btn.addEventListener("click", () => {
      const m = Number(btn.getAttribute("data-min"));
      setMinutes(m);
    });
  });

  // Initial render
  render();
</script>
</body>
</html>
